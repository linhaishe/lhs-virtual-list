# 论文修改稿件

## 1系统开发

本后台管理系统的开发环境是：使用的32位macOS Ventura的操作系统，服务器使用Heroku，数据库采用MySQL5.6.24，开发语言Node v16.20.0，React16。

### 4.1.1前端代码组织

前端项目使用飞冰 (ICE)管理工程项目，引入依赖文件，配置开发环境，组织代码打包上线。前端项目文件组织大致划分了buildTools、mock、public、src等四个文件夹，src文件下会有component、pages、utils等文件夹。buildTools包含的是构建导出后的会使用的基础工具。mock包含的是本地的一些测试文件数据，public用于存放静态资源的目录，此目录下所有的文件会被复制到构建产物目录中。src是用于存放源码的目录。

### 4.1.2后端代码组织

后端项目使用node和express-session搭建项目，后端项目文件组织结构分别为config、controller、router等三个文件夹，config包含整个项目连接数据库的代码，controller包含整个项目中各个页面的接口处理，是业务逻辑层实现代码的地方。router包含所有需要用到的接口的定义。

### 4.1.3前端请求后端数据方式

这段代码需要实现一个正常的 HTTP 请求配置，包括跨域携带 cookie 和 token，设置超时时间，并设置请求和响应的拦截器。在请求成功时，如果业务状态码为 200，则自动解析 result 数据，无需逐层判断获取数据。如果业务状态码不是 200，则全局提示服务端的错误信息。如果 HTTP 请求不成功，则全局提示报错信息。另外，当 HTTP 请求或业务状态码为 401 时，需要执行注销操作。还有一个全局的 loading 配置，默认开启，但可配置关闭。此外，由于后端问题，可能需要前端加入防抖节流。

```js
import axios, { AxiosInstance, AxiosRequestConfig } from "axios";
import { Message } from "@alifd/next";
import { jumpLogin } from "@/utils";
import { Loading } from "@alifd/next";

let loadingInstance = null;
let requestNum = 0;

const addLoading = () => {
  // 增加loading 如果pending请求数量等于1，弹出loading, 防止重复弹出
  requestNum++;
  if (requestNum == 1) {
    loadingInstance = Loading.service({
      text: "正在努力加载中....",
      background: "rgba(0, 0, 0, 0)",
    });
  }
};

const cancelLoading = () => {
  // 取消loading 如果pending请求数量等于0，关闭loading
  requestNum--;
  if (requestNum === 0) loadingInstance?.close();
};

export const createAxiosByinterceptors = (
  config?: AxiosRequestConfig
): AxiosInstance => {
  const instance = axios.create({
    timeout: 1000,    //超时配置
    withCredentials: true,  //跨域携带cookie
    ...config,   // 自定义配置覆盖基本配置
  });

  // 添加请求拦截器
  instance.interceptors.request.use(
    function (config: any) {
      // 在发送请求之前做些什么
      const { loading = true } = config;
      console.log("config:", config);
      // config.headers.Authorization = vm.$Cookies.get("vue_admin_token");
      if (loading) addLoading();
      return config;
    },
    function (error) {
      // 对请求错误做些什么
      return Promise.reject(error);
    }
  );

  // 添加响应拦截器
  instance.interceptors.response.use(
    function (response) {
      // 对响应数据做点什么
      console.log("response:", response);
      const { loading = true } = response.config;
      if (loading) cancelLoading();
      const { code, data, message } = response.data;
      if (code === 200) return data;
      else if (code === 401) {
        jumpLogin();
      } else {
         Message.error(message);
         return Promise.reject(response.data);
      }
    },
    function (error) {
      // 对响应错误做点什么
      console.log("error-response:", error.response);
      console.log("error-config:", error.config);
      console.log("error-request:", error.request);
      const { loading = true } = error.config;
      if (loading) cancelLoading();
      if (error.response) {
        if (error.response.status === 401) {
          jumpLogin();
        }
      }
      Message.error(error?.response?.data?.message || "服务端异常");
      return Promise.reject(error);
    }
  );
  return instance;
};
```

## 4.2页面布局设计与实现

​		函数 layoutContainer：这个函数以 layoutConfig 对象作为参数，其中包含布局的配置选项。它解构了 layoutConfig 对象以提取诸如 showSideBar、simpleHeader 和 isEmpty 等属性。如果 layoutConfig 为 null 或 undefined，则默认这些属性为 false。接着，它使用 getPageLayoutConfig() 函数获取当前页面的布局配置。这可能会获取特定于正在渲染的页面的一些设置。进一步解构 pageConfig 对象以提取诸如 useLoginInfo、showFoot、showAvatar 和 isRedirect 等属性。这些属性可能控制用户认证、页脚可见性和重定向等功能。如果 isRedirect 为 true，则返回一个函数，直接渲染其子元素，有效地跳过布局。renderContent 函数检查当前页面是否有权限查看。如果有权限，则渲染子元素；否则，渲染一个指示无权限的组件。

​        返回的函数：layoutContainer 函数返回另一个函数，以 props 作为其参数。这个返回的函数充当实际的布局组件。在这个函数内部，根据配置选项渲染布局结构：如果布局不为空（isEmpty 为 false），则渲染具有标题、侧边栏、内容区域和页脚的布局。如果布局为空，则只渲染内容区域。根据 simpleHeader 选项条件性地渲染简化的标题。根据 showSideBar 选项条件性地渲染侧边栏。如果在 pageConfig 中提供了面包屑导航，则渲染面包屑导航。渲染内容时，通过 renderContent 函数检查页面权限。如果布局为空，则直接渲染内容，不包含任何额外的布局元素。

​		导出的布局：导出了三种类型的布局：BaseLayout、SimpleLayout 和 EmptyLayout，每种都具有不同的配置：BaseLayout 包括侧边栏和标准标题。SimpleLayout 具有简化的标题（无头像）和没有侧边栏。EmptyLayout 仅渲染内容，没有任何额外的布局元素。

```tsx
import React from 'react';
import { Breadcrumb } from '@alifd/next';
import { getPageLayoutConfig } from '@/config/pageLayoutConfig';
import PageEntry from '@/components/PageEntry/index';
import Header from './components/Header';
import SideBar from './components/SideBar';
import Footer from './components/Footer';
import NoPermission from '@/components/NoPermission';
import { GlobalProvider } from './context';
import { checkCurrentPagePermission } from '@/utils/permission';
import './index.less';
import classnames from 'classnames';

const layoutContainer = (layoutConfig) => {
  const { showSideBar = false, simpleHeader = false, isEmpty = false } = layoutConfig || {};
  // 获取不同路径下的页面layout配置
  const pageConfig = getPageLayoutConfig();
  const { useLoginInfo = true, showFoot = false, showAvatar = true, isRedirect = false } = pageConfig;
  // 重定向路由，跳过layout
  if (isRedirect) return ({ children }) => children;
  // 【权限管控】校验当前页面是否有权限
  const renderContent = (children) => {
    return checkCurrentPagePermission() ? children : <NoPermission styles={isEmpty ? { height: '100vh' } : {}} />
  }

  return (props) => {
    return (
      <PageEntry>
        <GlobalProvider useLoginInfo={useLoginInfo}>
        {
          !isEmpty ? (
              <div className="layout-wrap">
                <div className="layout-header">
                  {!simpleHeader ? <Header /> : <Header showAvatar={showAvatar} useLoginInfo={useLoginInfo} />}
                </div>
                <div className="layout-body">
                  {showSideBar && <div className="layout-body-sidebar">
                    <SideBar />
                  </div>}
                  <div id='layoutContent' className={classnames(["layout-body-content-wrap", { "layout-body-content-simple-layout": simpleHeader }])}>
                    <div className="layout-body-content">
                      {
                        pageConfig?.breadcrumb?.length ? (
                          <Breadcrumb className="panama-breadcrumb">
                            {
                              (pageConfig.breadcrumb || []).map((item, index) => (
                                <Breadcrumb.Item key={index} link={item.value}>{item.label}</Breadcrumb.Item>
                              ))
                            }
                          </Breadcrumb>
                        ) : null
                      }
                      {renderContent(props.children)}
                    </div>
                  </div>
                </div>
                {showFoot ? <Footer /> : null}
              </div>
          ) : renderContent(props.children)
        }
        </GlobalProvider>
      </PageEntry>
    );
  };
}


const BaseLayout = layoutContainer({ showSideBar: true });
const SimpleLayout = layoutContainer({ simpleHeader: true });
const EmptyLayout = layoutContainer({ isEmpty: true });

export { BaseLayout, SimpleLayout, EmptyLayout };
```



## 4.3用户登录和权限模块

### 4.3.1用户登录

我们会有一个用户登录的处理，大概的逻辑：

https://blog.csdn.net/Joshmo/article/details/113132794

### 4.3.2路由权限

基础的权限控制会在前端处理，挂在在window的permissionPage上，有不需要权限的页面，也有需要权限的页面

```
// 工作台首页
import Dashboard from './pages/Dashboard';

/** * ======================================================================== *
baseLayout *
======================================================================== * */ 

const routerConfig = [
{ path: '/', component: BaseLayout, children: 
[ // 工作台首页 
  { path:'/dashboard', component: Dashboard, pageConfig: { spm: 'dashboard' } }, 
  //订单/采购管理部分 
  { path: '/order/list', component: OrderList, pageConfig: {spm: '26915986' } }, 
  { path: '/workorder/list', component: WorkorderList,pageConfig: { spm: 'workorder_list' } }, 
  { path: '/refund/list', component: RefundList, pageConfig: { spm: 'refund_list' } }, 
  { path: '/refund/detail', component: RefundDetail, pageConfig: { spm: '26186852' } }, 
  { path: '/cart/list', component: CartList, pageConfig: { spm: 'cart_list' } }, 
  { path: '/cart/confirm', component: CartConfirm, pageConfig: { spm: 'confirm_cart_list'} }, 
  // 公告 
  { path: '/announce/list', component: AnnounceList, pageConfig: {spm: 'announce_list', permissionControl: false, } }, 
  { path: '/announce/detail',component: AnnounceDetail, pageConfig: { spm: 'announce_detail', permissionControl: false, } }, 
// 选品铺货 
{ path: '/product/list', component: ProductList, pageConfig: { spm: '20960503' } }, 
{ path: '/distribute/list', component: DistributeList, pageConfig: { spm: '21025972' } }, 
{ path:'/distribute/taskList', component: DistributeTaskList, pageConfig: { spm: 'distribute_task_list' } }, 
{ path: '/selection/list', component: SelectionList, pageConfig: { spm: 'selection_list' } }, 
{ path: '/selection/create', component:SelectionCreate, pageConfig: { spm: 'selection_create' } }, 
{ path: '/selection/edit/:sid', component: SelectionCreate, pageConfig: { spm: 'selection_edit' } }, 
{ path: '/selection/copy/:sid', component: SelectionCreate, pageConfig: { spm: 'selection_copy' } }, 
{ path: '/selection/detail/:sid', component: SelectionCreate, pageConfig: { spm: 'selection_detail' } }, 
// FBI报表 
{ path: '/report/list/:reportId', component: ReportList, pageConfig: { spm: 'report_list' } }, 
//对账管理——兼容发布过程中的老路由逻辑，后期可删除此路由及对应page 
{ path:'/bill/list', component: BillList, pageConfig: { spm: '21296137' } }, 
{ path: '/refundBill/list', component: RefundBillList, pageConfig: { spm:'refund_bill_list' } }, 
// 物流详情 
{ path: '/logistics/detail', component: LogisticsDetails, pageConfig: { spm: 'logistics_detail' } }, 
// 返佣管理 
{ path: '/account/bindPub', component: AccountBindPub, pageConfig: { spm: 'bind_pub_account' } }, 
// 员工管理 
{ path: '/account/list', component: AccountList, pageConfig: { spm: 'account_list' } }, 
{ path: '/account/create', component: AccountCreate, pageConfig: { spm: 'account_create' } }, 
{ path: '/role/list', component: RoleList, pageConfig: { spm: 'role_list' } }, 
{ path: '/role/create', component: RoleCreate, pageConfig: { spm: 'role_create' } }, 
{ path: '/role/edit', component: RoleCreate, pageConfig: { spm: 'role_edit' } },
// 工作台首页统一重定向 
{ path: '/index', ...redirect('/dashboard') }, 
{ path: '/', exact: true, ...redirect('/dashboard') }
}];

<script type="text/javascript">
  // 权限配置
  window.CLINIC_PERMISSION_CONFIG = window.CLINIC_PERMISSION_CONFIG || {};
  // 基础权限页面
  PANAMA_PERMISSION_CONFIG.MENU_LIST = [
    {
      "id": "1",
      "title": "采购管理",
      "icon": "https://img.alicdn.com/imgextra/i1/O1CN01uKh7qT1IYXHhCZ1gH_!!6000000000905-2-tps-32-32.png",
      "group": [
        { "id": "14", "title": "购物车", "url": "/apps/cart/list" },
        { "id": "11", "title": "订单管理", "url": "/apps/order/list" },
        { "id": "12", "title": "退货退款", "url": "/apps/refund/list" },
        { "id": "13", "title": "工单管理", "url": "/apps/workorder/list" },
        { "id": "19", "title": "物流管理", "url": "/apps/report/list/12345678" }
      ]
    },
    {
      "id": "2",
      "title": "商品铺货",
      "icon": "https://img.alicdn.com/imgextra/i1/O1CN01OTksek1KxO0QDeqEk_!!6000000001230-2-tps-32-32.png",
      "group": [
        { "id": "23", "title": "选品管理", "url": "/apps/selection/list" },
        { "id": "24", "title": "铺货任务管理", "url": "/apps/distribute/taskList" },
        { "id": "22", "title": "铺货商品管理", "url": "/apps/distribute/list" },
        { "id": "21", "title": "商品搜索", "url": "/apps/product/list" },
      ]
    },
    {
      "id": "3",
      "title": "账单管理",
      "icon": "https://img.alicdn.com/imgextra/i2/O1CN01SacVdC1elHrO2v1dB_!!6000000003911-2-tps-32-32.png",
      "group": [
        { "id": "31", "title": "支付对账", "url": "/apps/report/list/1391465" },
        { "id": "32", "title": "退款对账", "url": "/apps/report/list/1276123" }
      ]
    },
    {
      "id": "4",
      "title": "返佣管理",
      "url": "/apps/account/bindPub",
      "icon": "https://img.alicdn.com/imgextra/i3/O1CN01A6KDta1FUvJV8029e_!!6000000000491-2-tps-32-32.png",
    },
    {
      "id": "5",
      "title": "员工管理",
      "icon": "https://img.alicdn.com/imgextra/i2/O1CN01itpcXB1W7sr9C35ZO_!!6000000002742-2-tps-32-32.png",
      "group": [
        { "id": "51", "title": "账号管理", "url": "/apps/account/list" },
        { "id": "52", "title": "岗位管理", "url": "/apps/role/list" }
      ]
    }
  ];
  
  // 权限页面
  PANAMA_PERMISSION_CONFIG.PERMISSION_LIST = [
    { "id": "0", "url": "/apps/dashboard",
      "buttonList": [
        { "id": 1111, "name": "contactSupplier" },
      ]
    },
    { "id": "0", "url": "/apps/cart/list",
      "buttonList": [
        { "id": 1111, "name": "contactSupplier" }
      ]
    },
    { "id": "0", "url": "/apps/cart/confirm",
      "buttonList": [
        { "id": 1111, "name": "contactSupplier" }
      ]
    },
    { "id": "211", "url": "/apps/product/detail",
      "buttonList": [
        { "id": 1111, "name": "contactSupplier" },
        { "id": 2222, "name": "cancelDistribute" }
      ]
    },
    { "id": "22", "url": "/apps/distribute/list",
      "buttonList": [
        { "id": 1111, "name": "distribute" },
        { "id": 2222, "name": "cancelDistribute" }
      ]
    },
  ];
</script>
```

